<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Visiting Card Extractor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: none;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .user-info button {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* Authentication Forms */
        .auth-container {
            padding: 40px;
            max-width: 500px;
            margin: 0 auto;
        }

        .auth-form {
            background: #f8f9ff;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
        }

        .form-group input:focus {
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Main App Styles */
        .main-content {
            padding: 40px;
            display: none;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px 30px;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-box.dragover {
            border-color: #28a745;
            background: #f0fff0;
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .contact-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .contact-field {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .field-label {
            font-weight: bold;
            color: #667eea;
            width: 120px;
            min-width: 120px;
        }

        .field-value {
            color: #333;
            flex: 1;
        }

        .query-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 1px solid #eee;
        }

        .query-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .query-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1.1em;
            outline: none;
        }

        .query-input:focus {
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #667eea;
        }

        .error {
            background: #fff5f5;
            color: #e53e3e;
            border: 1px solid #fed7d7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .success {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #c6f6d5;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .token-info {
            background: #fff7ed;
            color: #dd6b20;
            border: 1px solid #fbd38d;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-switch a {
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .query-box {
                flex-direction: column;
            }
            
            .contact-field {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .field-label {
                margin-bottom: 5px;
            }

            .user-info {
                position: static;
                margin-top: 20px;
                background: rgba(255,255,255,0.3);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Secure Visiting Card Extractor</h1>
            <p>AI-powered contact extraction with user authentication</p>
            
            <div class="user-info" id="userInfo">
                <span id="userEmail"></span>
                <button onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="auth-container" id="authContainer">
            <!-- Login Form -->
            <div class="auth-form" id="loginForm">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Sign In</h2>
                
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                
                <button class="btn" onclick="login()" id="loginBtn">Sign In</button>
                
                <div class="auth-switch">
                    Don't have an account? <a onclick="showRegisterForm()">Sign up here</a>
                </div>
            </div>

            <!-- Register Form -->
            <div class="auth-form" id="registerForm" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Create Account</h2>
                
                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password" required>
                </div>
                
                <div class="form-group">
                    <label for="registerFullName">Full Name</label>
                    <input type="text" id="registerFullName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label for="registerCompany">Company (Optional)</label>
                    <input type="text" id="registerCompany" placeholder="Your company name">
                </div>
                
                <button class="btn" onclick="register()" id="registerBtn">Create Account</button>
                
                <div class="auth-switch">
                    Already have an account? <a onclick="showLoginForm()">Sign in here</a>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div class="main-content" id="mainContent">
            <!-- Upload Section -->
            <div class="upload-section">
                <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Click to upload or drag and drop your visiting card image</div>
                    <div class="upload-text" style="font-size: 0.9em; color: #999;">
                        Supports: JPG, JPEG, PNG, WEBP (Max: 16MB)
                    </div>
                    <button class="btn" type="button">Choose File</button>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".jpg,.jpeg,.png,.webp">
            </div>

            <div class="results-section" id="results">
                <!-- Results will be populated here -->
            </div>

            <!-- Search Section -->
            <div class="query-section">
                <h3>üîç Search Your Contacts</h3>
                <div class="query-box">
                    <input type="text" class="query-input" id="queryInput" 
                           placeholder="Search by company, name, category, services...">
                    <button class="btn" onclick="searchContacts()">Search</button>
                    <button class="btn" onclick="loadAllContacts()">View All</button>
                </div>
                <div id="queryResults"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let authToken = null;
        let isProcessing = false;

        // Initialize app
        window.onload = function() {
            console.log('üöÄ Secure Visiting Card Extractor initialized');
            checkAuthState();
        };

        // Authentication State Management
        function checkAuthState() {
            authToken = localStorage.getItem('authToken');
            const userEmail = localStorage.getItem('userEmail');
            
            if (authToken && userEmail) {
                currentUser = { email: userEmail };
                showMainApp();
                testBackendConnection();
            } else {
                showAuthContainer();
            }
        }

        // Test backend connection
        function testBackendConnection() {
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ Backend connection successful:', data);
                })
                .catch(error => {
                    console.error('‚ùå Backend connection failed:', error);
                    showError('Backend connection failed. Please check if the server is running.');
                });
        }

        // Authentication Functions
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');

            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                if (result.success) {
                    authToken = result.token || 'authenticated';
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('userEmail', email);
                    currentUser = { email };
                    showMainApp();
                    showSuccess('Logged in successfully!');
                } else {
                    showError(result.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed: ' + error.message);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const fullName = document.getElementById('registerFullName').value;
            const company = document.getElementById('registerCompany').value;
            const registerBtn = document.getElementById('registerBtn');

            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }

            registerBtn.disabled = true;
            registerBtn.textContent = 'Creating account...';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, full_name: fullName, company })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('Account created successfully! Please sign in.');
                    showLoginForm();
                    document.getElementById('loginEmail').value = email;
                } else {
                    showError(result.error || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showError('Registration failed: ' + error.message);
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'Create Account';
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            authToken = null;
            currentUser = null;
            showAuthContainer();
            showSuccess('Logged out successfully');
        }

        // UI State Management
        function showAuthContainer() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        // File Upload Handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                processImage(e.target.files[0]);
            }
        });

        // Drag and drop handling
        const uploadBox = document.querySelector('.upload-box');
        
        uploadBox.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        });

        uploadBox.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
        });

        uploadBox.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processImage(files[0]);
            }
        });

        async function processImage(file) {
            if (isProcessing) return;
            
            isProcessing = true;
            showLoading();

            const formData = new FormData();
            formData.append('image', file);

            try {
                console.log('üîÑ Processing image:', file.name);
                
                const response = await fetch('/api/process-visiting-card', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: formData
                });

                console.log('üì° Response status:', response.status);

                if (!response.ok) {
                    if (response.status === 401) {
                        showError('Authentication required. Please log in again.');
                        logout();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ Processing result:', result);
                displayResults(result);

            } catch (error) {
                console.error('üí• Error processing image:', error);
                showError('Error processing image: ' + error.message);
            } finally {
                isProcessing = false;
            }
        }

        // Search Functions
        async function searchContacts() {
            const query = document.getElementById('queryInput').value;
            if (!query.trim()) return;

            console.log('üîç Searching for:', query);

            try {
                const response = await fetch('/api/search-contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify({ query: query, limit: 5 })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showError('Authentication required. Please log in again.');
                        logout();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('üîé Search result:', result);
                displayQueryResults(result);

            } catch (error) {
                console.error('üí• Error searching contacts:', error);
                showQueryError('Error searching contacts: ' + error.message);
            }
        }

        async function loadAllContacts() {
            console.log('üìá Loading all contacts');
            
            try {
                const response = await fetch('/api/contacts', {
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showError('Authentication required. Please log in again.');
                        logout();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('üìã All contacts result:', result);
                displayQueryResults(result, 'All Your Contacts');

            } catch (error) {
                console.error('üí• Error loading contacts:', error);
                showQueryError('Error loading contacts: ' + error.message);
            }
        }

        // Display Functions
        function showLoading() {
            document.getElementById('results').innerHTML = `
                <div class="loading">
                    üîÑ Processing your visiting card... Please wait.
                </div>
            `;
            document.getElementById('results').style.display = 'block';
        }

        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            
            if (!result.success) {
                resultsDiv.innerHTML = `<div class="error">‚ùå ${result.error}</div>`;
                return;
            }

            const contact = result.contact_info;
            const business = result.business_intelligence || {};
            const tokenInfo = result.token_validation;

            resultsDiv.innerHTML = `
                <div class="success">‚úÖ Contact information extracted successfully!</div>
                
                ${tokenInfo ? `
                <div class="token-info">
                    üìä Tokens used: ${result.tokens_used || 0} / ${tokenInfo.total_tokens} 
                    (${tokenInfo.remaining_tokens} remaining)
                </div>
                ` : ''}
                
                <div class="contact-card">
                    <h3>üìã Contact Information</h3>
                    ${Object.entries(contact).filter(([key, value]) => 
                        value && value !== 'null' && !['business_category', 'business_subcategory', 'industry_keywords', 'services_offered', 'target_market', 'business_type', 'company_size', 'geographic_scope', 'specializations'].includes(key)
                    ).map(([key, value]) => `
                        <div class="contact-field">
                            <div class="field-label">${capitalizeFirst(key)}:</div>
                            <div class="field-value">${
                                Array.isArray(value) ? value.join(', ') : value
                            }</div>
                        </div>
                    `).join('')}
                </div>
                
                ${business.category ? `
                <div class="contact-card" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);">
                    <h3>üß† Business Intelligence</h3>
                    <div class="contact-field">
                        <div class="field-label">Business Category:</div>
                        <div class="field-value"><strong>${business.category}</strong></div>
                    </div>
                    ${business.subcategory ? `
                    <div class="contact-field">
                        <div class="field-label">Specialization:</div>
                        <div class="field-value">${business.subcategory}</div>
                    </div>
                    ` : ''}
                    ${business.services ? `
                    <div class="contact-field">
                        <div class="field-label">Services:</div>
                        <div class="field-value">${business.services}</div>
                    </div>
                    ` : ''}
                    ${business.target_market ? `
                    <div class="contact-field">
                        <div class="field-label">Target Market:</div>
                        <div class="field-value">${business.target_market}</div>
                    </div>
                    ` : ''}
                    ${business.keywords && business.keywords.length > 0 ? `
                    <div class="contact-field">
                        <div class="field-label">Industry Keywords:</div>
                        <div class="field-value">
                            ${business.keywords.map(keyword => 
                                `<span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.9em; margin: 2px;">${keyword}</span>`
                            ).join(' ')}
                        </div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
                
                <div class="contact-card" style="background: #f0fff4;">
                    <div style="text-align: center; color: #38a169;">
                        üéØ <strong>This contact is securely stored and searchable!</strong><br>
                        <small>Try searching: "${business.category || 'business'} services", "companies in ${business.category || 'this industry'}", etc.</small>
                    </div>
                </div>
            `;
        }

        function displayQueryResults(result, title = 'Search Results') {
            const queryResults = document.getElementById('queryResults');
            
            if (!result.success) {
                queryResults.innerHTML = `<div class="error">‚ùå ${result.error}</div>`;
                return;
            }

            const items = result.results || result.contacts || [];
            
            if (items.length === 0) {
                queryResults.innerHTML = `<div class="error">üîç No contacts found</div>`;
                return;
            }

            queryResults.innerHTML = `
                <h4>${title} (${items.length} found)</h4>
                ${items.map(item => {
                    // Use contact_data if available, otherwise fall back to metadata
                    const contact = item.contact_data || {};
                    const metadata = item.metadata || {};
                    
                    return `
                    <div class="contact-card">
                        <div class="contact-field">
                            <div class="field-label">Name:</div>
                            <div class="field-value">${contact.name || metadata.name || 'N/A'}</div>
                        </div>
                        <div class="contact-field">
                            <div class="field-label">Company:</div>
                            <div class="field-value">${contact.company || metadata.company || 'N/A'}</div>
                        </div>
                        <div class="contact-field">
                            <div class="field-label">Position:</div>
                            <div class="field-value">${contact.position || metadata.position || 'N/A'}</div>
                        </div>
                        <div class="contact-field">
                            <div class="field-label">Email:</div>
                            <div class="field-value">${contact.email || metadata.email || 'N/A'}</div>
                        </div>
                        <div class="contact-field">
                            <div class="field-label">Phone:</div>
                            <div class="field-value">${
                                Array.isArray(contact.phone) ? contact.phone.join(', ') : 
                                (contact.phone || 'N/A')
                            }</div>
                        </div>
                        <div class="contact-field">
                            <div class="field-label">Address:</div>
                            <div class="field-value">${contact.address || 'N/A'}</div>
                        </div>
                        <div class="contact-field">
                            <div class="field-label">Website:</div>
                            <div class="field-value">${contact.website || 'N/A'}</div>
                        </div>
                        ${item.created_at ? `
                        <div class="contact-field">
                            <div class="field-label">Added:</div>
                            <div class="field-value">${new Date(item.created_at).toLocaleDateString()}</div>
                        </div>
                        ` : ''}
                        ${item.similarity !== undefined ? `
                        <div class="contact-field">
                            <div class="field-label">Relevance:</div>
                            <div class="field-value">${(item.similarity * 100).toFixed(0)}%</div>
                        </div>
                        ` : ''}
                    </div>
                    `;
                }).join('')}
            `;
        }

        // Utility Functions
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1).replace('_', ' ');
        }

        function showError(message) {
            const errorDiv = document.getElementById('results');
            errorDiv.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.innerHTML = `‚úÖ ${message}`;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '1000';
            successDiv.style.maxWidth = '300px';
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function showQueryError(message) {
            document.getElementById('queryResults').innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }

        // Enter key support for search
        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchContacts();
            }
        });
    </script>
</body>
</html>